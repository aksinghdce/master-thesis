<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Master Thesis Prototype</title>
        <style>
            body {
                font-family: sans-serif;
                font-size: 1.0em;
                font-weight: 300;
            }
        </style>
    </head>
    <body>
        <h1>Proto</h1>
        <div id="container"></div>
    <script src="js/jquery-2.2.3.min.js"></script>
    <script>
        // so far i saw three data structures (each max 2 levels deep: 1. list itself, 2. details)
        // - iCarWash: few list items, with up to 5 nodes containing car wash detials / data,
        // - Pracuj.pl: moderate length list; ad details downloaded on demand
        // - OLX: long lists, downloaded as pages of ca. 15 items. Item details downloaded with page.
        // This alone shows that making a library can be (well is) difficult. Problem here
        // is that the frontend client (the app) has to adapt do the server protocol (not vice versa).
        // IMO there is no point of making a library â†’ won't be any good
        // But I'll try!
        'use strict';
        var iCarWash    = Object.create(null);

        iCarWash.urlRoot    = 'http://localhost:8000/data/icarwash/';
        iCarWash.urlList    = iCarWash.urlRoot + 'carwash-list';
        iCarWash.urlAlarms  = iCarWash.urlRoot + 'alarms/';
        iCarWash.urlAutodiagnostics = iCarWash.urlRoot + 'autodiagnostics/';
        iCarWash.urlEvents  = iCarWash.urlRoot + 'events/';
        iCarWash.urlFinance = iCarWash.urlRoot + 'finance/';
        iCarWash.urlMonitor = iCarWash.urlRoot + 'monitor/';
        iCarWash.cache      = null;

        /**
         * Retrives JSON from given URL and triggers the successCallback function on success.
         *
         * @param string url
         * @param object dst
         */
        function get(url, successCallback) {
            $.ajax({
                dataType: 'json',
                url: url,
                success: successCallback
            });
        }

        /**
         * A jQuery success handler (possible parameters data, statusText, jqXhr)
         */
        function downloadList(data) {
            iCarWash.cache = data.content;
            // download details for each list item
            iCarWash.cache.forEach(function (item) {
                // alarms
                get((iCarWash.urlAlarms + item.id), function (data) { item.alarms = data.content; });
                // autodiagnostics
                get((iCarWash.urlAutodiagnostics + item.id), function (data) { item.autodiagnostics = data.content; });
                // events
                get((iCarWash.urlEvents + item.id), function (data) { item.events = data.content; });
                // finance
                get((iCarWash.urlFinance + item.id), function (data) { item.finance = data.content; });
                // monitor
                get((iCarWash.urlMonitor + item.id), function (data) { item.monitor = data.content; });
            });
            renderList(iCarWash.cache);
        }

        function renderList(list) {
            var clone = null,
                table = document.createElement('table'),
                tr    = document.createElement('tr'),
                td1   = document.createElement('td'),
                td2   = document.createElement('td');

            $('#container').html(null);
            $(tr).append(td1, td2);
            $(list).each(function (index, element) {
                $(td1).text(element.serialNumber);
                $(td2).text(element.username);
                clone = $(tr).clone(true);
                $(clone).click(function () { renderDetailsMenu(element.id); });
                $(table).append(clone);
            });

            $('#container').append(table);
        }

        function renderDetailsMenu(itemId) {
            var elmBack     = document.createElement('div'),
                elmAlarm    = document.createElement('div'),
                elmAuto     = document.createElement('div'),
                elmEvent    = document.createElement('div'),
                elmFinance  = document.createElement('div'),
                elmMonitor  = document.createElement('div');

            elmBack.onclick = function () { renderList(iCarWash.cache); };
            elmBack.innerText = 'back';

            elmAlarm.onclick = function () { console.log('alarms for ' + itemId); };
            elmAlarm.innerText = 'Alarms';

            elmAuto.onclick = function () { console.log('autodiagnostics for ' + itemId); };
            elmAuto.innerText = 'Autodiagnostics';

            elmEvent.onclick = function () { console.log('events for ' + itemId); };
            elmEvent.innerText = 'Events';

            elmFinance.onclick = function () { console.log('finance for ' + itemId); };
            elmFinance.innerText = 'Finance';

            elmMonitor.onclick = function () { console.log('monitor for ' + itemId); };
            elmMonitor.innerText = 'Monitor';

            $('#container').html(null);
            $('#container').append(elmBack, elmAlarm, elmAuto, elmEvent, elmFinance, elmMonitor);
        }

        get(iCarWash.urlList, downloadList);
// so... we've got our results cached. So how do we get a concrete item?
// this needs addressing.
    </script>
    </body>
</html>
